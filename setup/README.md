# Setup Instructions (English)

## Recommended Usage
- Use SSH to connect to the thu-sui server from your local IDE (e.g., VS Code or Cursor) for code maintenance on the server.
- Virtuoso should run on the compute server; for cross-server access, use the ramic_bridge tool (see details below).
- Use csh (not bash, etc.) and configure the environment using the setup.csh script described below.

## Quick Start (csh-based)
1) Clone the repository (private repository, contact administrator for access if needed) and enter the directory
```csh
git clone https://github.com/Arcadia-1/RAMIC.git
```

2) Enter the project directory
The following steps assume you are operating in the AMS-IO-Agent directory (containing `setup.csh`, `README.md`, etc.).
```csh
cd RAMIC/AMS-IO-Agent
```

3) Run the automated setup script (do not enter the virtual environment at this point; run directly in the AMS-IO-Agent folder)

**Quick Start (Recommended):**
```csh
./quick_start.csh
```
This script will automatically fix permissions and run the complete setup process.

**Manual Setup:**
```csh
./setup/setup.csh
```

**Note:** If you encounter "Permission denied" errors, run:
```csh
chmod +x quick_start.csh setup/*.csh
./quick_start.csh
```

**Script Execution Process:**
- Automatically sets up Python development environment (installs uv, creates .venv virtual environment, installs requirements.txt dependencies)
- Calls generate_env_config.csh to generate .env configuration file
- Calls generate_virtuoso_ramicbridge.csh or generate_virtuoso_skillbridge.csh to generate virtuoso_setup.il file
- Zero interaction, one-click initialization from scratch to runnable state

**Generated Key Files:**
- **`.env`**: Stores project configuration and sensitive information (API keys, CDS paths, etc.) for program runtime; contains sensitive information and will not be uploaded to Git; if path settings are incorrect, you can directly edit this file; cd to your design folder and use `realpath cds.lib` to quickly get the full absolute path
- **`virtuoso_setup.il`**: Auto-generated SKILL script containing complete commands and absolute paths needed to load Python bridge (skillbridge or RAMIC Bridge) in Virtuoso CIW
- **`.venv/`**: Python virtual environment directory, isolating project dependencies

**Notes:**
- All paths generated by `setup.csh` are absolute paths; following the prompts will avoid path errors
- Script must be run in **global environment** (not in virtual environment)

4) Connect to Virtuoso

There are currently two methods to connect to Virtuoso: ramic bridge and skillbridge.
 - Recommended: ramic bridge. It can connect across servers, e.g., code runs on thu-sui while Virtuoso runs on thu-tang.
 - If a full Virtuoso installation is available on thu-sui in the future, skillbridge can be used

#### Method A: RAMIC Bridge (Recommended)

Execute in Virtuoso CIW:

```skill
load("/path/to/AMS-IO-Agent/virtuoso_setup.il")
```

**Environment Variable Setup:**

The generated `virtuoso_setup.il` already includes environment variable settings (using `setShellEnvVar()`), no manual configuration needed.

If you encounter issues, you can also manually set before starting Virtuoso (optional):
```csh
# Execute in the terminal where Virtuoso is started
setenv RB_DAEMON_PATH "/path/to/AMS-IO-Agent/src/tools/ramic_bridge/ramic_bridge_daemon_27.py"
virtuoso &
```

**Cross-Server Connection**: SSH Port Forwarding Required

Due to server firewall restrictions, connecting to the compute server requires SSH forwarding.
Command line examples:
```csh
ssh -N -L 65432:127.0.0.1:65432 lixintian@thu-wei
```
or
```csh
ssh -N -L 65434:127.0.0.1:65432 zhangz@thu-tang
```
You need to click "start" in the RAMIC menu bar in CIW to start the service


#### Method B: skillbridge

Execute in Virtuoso CIW:

```skill
load("/path/to/AMS-IO-Agent/virtuoso_setup.il")
```

**Note**: `virtuoso_setup.il` will automatically load the skillbridge server and start `pyStartServer`.



5) Test if Bridge Configuration is Successful


Test Communication
```csh
source .venv/bin/activate.csh (if not already activated)
python -X utf8 src/tools/ramic_bridge/ramic_bridge.py
```

If execution is successful and CIW returns multiple empty lines, the configuration is successful.

6) Start Main Program (AI Assistant)

After confirming the bridge is available, start the main program following these steps (must be in virtual environment!):

```csh
# Start AI Assistant
python src/main.py

AI interaction example: 3 pads per side. Single ring layout. Order: counterclockwise through left side, bottom side, right side, top side.Signal names: RSTN SCK SDI SDO D4 D3 D2 D1 VIOL GIOL VIOH GIOH. Among them, digital IO signals need to connect to digital domain voltage domain (VIOL/GIOL/VIOH/GIOH).

# For Web UI
python src/main.py --model-name deepseek --prompt-name structured --webui
```

7) Run Project Tests and Examples

The project contains several test files and examples that can be used to verify functionality:

```csh
# Run individual tests
python tests/test_il_system.py
python tests/test_io_ring_tool.py

python src/main.py --prompt C_PEX_28nm_python_SKILL_en
```

If Virtuoso-related failures occur during testing, return to steps 3 and 4 to check Virtuoso/ramic_bridge connection and the il script loaded in CIW.

---
---

## Virtuoso Bridge Configuration (skillbridge and RAMIC)

`setup.csh` will generate `virtuoso_setup.il` containing instructions for the selected bridge (skillbridge or RAMIC). Below are key points for using csh with two common configurations.

A) Using skillbridge (default)
- Install and run `skillbridge` on the host, get its path (script will attempt auto-detection).
- Run in Virtuoso CIW (within CIW):
  - load(skillbridge server il path)
  - load `scripts/screenshot_complete.il` from the project
  - Execute `pyStartServer` in CIW to start Python server

B) Using RAMIC Bridge (lightweight socket-based bridge)
- Edit `.env`: set `USE_RAMIC_BRIDGE=true`
- Set bridge daemon path environment variable in csh (example):
```csh
setenv RB_DAEMON_PATH "/full/path/to/AMS-IO-Agent/src/tools/ramic_bridge/ramic_bridge_daemon_27.py"
```
- Load `src/tools/ramic_bridge/ramic_bridge.il` and `scripts/screenshot_complete.il` in Virtuoso CIW
- Start (or ensure) ramic_bridge daemon is running on the host and listening on `RB_HOST` / `RB_PORT` configured in `.env`

Tip: `setup.csh` will write corresponding steps in `virtuoso_setup.il`; you can open it and execute according to comments in Virtuoso CIW.

---

## Start Project / Common Commands (csh)

- Activate venv (if not activated in current session)
```csh
source .venv/bin/activate.csh
```

- Run AI Assistant (example)
```csh
python src/main.py --model-name deepseek --prompt-name structured
```

- Use web interface (if supported)
```csh
python src/main.py --model-name deepseek --prompt-name structured --webui
```

---

## Common Issues & Tips

- Q: How to keep virtual environment activated after creation?
  - A: Execute in your interactive shell:
    ```csh
    source .venv/bin/activate.csh
    ```
    If you only used `setup.csh` subprocess to create venv, you need to manually activate in the parent shell.

- Q: Virtuoso cannot write screenshots or load script fails
  - A:
    - Check if `scripts/screenshot.il` path exists and is readable;
    - Ensure paths in `virtuoso_setup.il` are absolute paths or consistent with Virtuoso's current working directory;
    - If using RAMIC Bridge, ensure daemon (`ramic_bridge_daemon_27.py`) has started on the specified host & port.

- Q: Why does `setup.csh` require cds.lib path input?
  - A: The project needs to know the Cadence CDS library file (cds.lib) location so CIW or scripts can reference the corresponding library path; incorrect paths may cause library loading failures.

- Q: Why does git error occur?
  - A: Network issues, try several times, or use SSH connection.

- Q: Error UnicodeEncodeError: 'gbk' codec can't encode character
  - A: This is an encoding error. `setup/setup.csh` will automatically configure UTF-8 encoding environment variables.
    
    If you have already run `setup.csh`, configuration will be automatically added to `~/.cshrc`, just reopen the terminal.
    
    If you need to manually configure, you can run:
    ```csh
    # Permanent configuration (recommended, add to ~/.cshrc)
    ./setup/setup_csh_env.csh --permanent
    source ~/.cshrc
    
    # Or temporary setting (current session only)
    source setup/setup_csh_env.csh
    ```
    
    This will set the following environment variables:
    - `PYTHONIOENCODING=utf-8`
    - `LC_ALL=en_US.UTF-8`
    - `LANG=en_US.UTF-8`
---

## Key Files (Quick Reference)
- `setup/setup.csh` — csh automated installation and configuration script
- `setup/setup_csh_env.csh` — UTF-8 encoding environment variable configuration script (usually automatically called by setup.csh)
- `setup/generate_env_config.csh` — Generate .env configuration file
- `setup/generate_virtuoso_*.csh` — Generate Virtuoso bridge configuration files
- `.env` — Runtime environment variables (API keys, USE_RAMIC_BRIDGE, etc.)
- `virtuoso_setup.il` — Generated by `setup.csh`, contains Virtuoso CIW loading script instructions
- `scripts/` — Contains SKILL scripts such as `screenshot.il`, `screenshot_complete.il`
- `src/main.py` — Program entry point
- `src/tools/bridge_utils.py` — Virtuoso bridge helper functions (skillbridge / ramic switching)

---
