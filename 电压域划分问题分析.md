# 电压域自动划分问题分析

## 发现的问题

### 问题1：电压域配对识别不完整
**现象**：
- AVDDVCO (idx=58) 被识别为独立域，只有Power，没有Ground
- AVSSVCO (idx=61) 被识别为独立域，只有Ground，没有Power
- 它们应该是一个电压域对（AVDDVCO/AVSSVCO）

**根本原因**：
- 当前实现可能使用了字符匹配算法，而不是语义理解
- **应该使用AI语义理解**来识别电压域配对：
  - AVDDVCO和AVSSVCO都包含"VCO"，语义上属于同一个功能模块（VCO模块）的电源对
  - AVDDH1和AVSS1都包含"1"，语义上属于同一个功能模块（编号1）的电源对
  - 应该基于信号名称的语义含义来配对，而不是字符模式匹配

### 问题2：连续性规则必须保持
**说明**：
- CVDD/CVSS被分成两个域是正确的：
  - Domain 1: Indices 2 to 5 (CVDD, CVSS)
  - Domain 2: Indices 16 to 17 (CVSS, CVDD)
- **分开的信号在物理上不连续，逻辑上也不属于同一个电压域**
- 每个连续的信号块应该被视为独立的电压域，即使信号名称相同

**正确理解**：
- 连续性要求必须保持，这是物理设计的约束
- 如果同一名称的信号被其他信号分隔，它们属于不同的电压域
- 每个连续块需要自己的提供者对

### 问题3：提供者选择应该基于语义理解
**现象**：
- 每个域中，所有同名信号都被标记为Power/Ground
- 例如AVDDH2域：两个AVDDH2都被标记为Power
- 但根据规则，只有第一个应该是提供者（PVDD3AC），其他应该是消费者（PVDD1AC）

**根本原因**：
- 当前可能使用了算法来选择提供者（如"第一个出现的"）
- **应该使用AI语义理解**来判断：
  - 哪个信号是主要的电源提供者（通常是第一个，但应该基于语义判断）
  - 哪些信号是消费者（从提供者接收电源的信号）
  - 不应该用简单的"第一个"算法，而应该理解信号在电路中的角色

### 问题4：数字电源被误识别为模拟电压域
**说明**：
- 此问题不需要修改知识库
- 数字电源和模拟电源的区分应该由AI语义理解自动完成

### 问题5：配对识别应该基于语义理解
**现象**：
- 无法识别变体命名模式：
  - AVDDH1/AVSS1（数字后缀匹配）
  - AVDDH2/AVSS2（数字后缀匹配）
  - AVDDH3/AVSS3（数字后缀匹配）
  - AVDDVCO/AVSSVCO（VCO后缀匹配）

**根本原因**：
- 当前可能使用了字符匹配算法
- **应该使用AI语义理解**来识别配对：
  - AVDDH1和AVSS1都包含"1"，语义上属于同一个功能模块的电源对
  - AVDDVCO和AVSSVCO都包含"VCO"，语义上属于VCO模块的电源对
  - 应该理解信号名称的语义含义，而不是用字符模式匹配算法

## 知识库修改建议

### 修改1：强调使用语义理解进行电压域配对

**当前规则**（第107-108行）：
```
- Group signals with similar base names (e.g., VDDIB/VSSIB, VDDSAR/VSSSAR, VDD_CKB/VSS_CKB)
- Identify power/ground pairs with matching suffixes or prefixes
```

**建议修改为**：
```
- **Use AI semantic understanding** to identify voltage domain pairings:
  - Understand the semantic meaning of signal names, not just character patterns
  - Examples of semantic pairing:
    - AVDDH1 and AVSS1: Both contain "1", semantically belong to the same functional module (module 1)
    - AVDDVCO and AVSSVCO: Both contain "VCO", semantically belong to VCO module
    - VDDIB and VSSIB: Both contain "IB", semantically belong to IB module
    - CVDD and CVSS: Both contain "C", semantically belong to C module
  - **Do NOT use character matching algorithms** - rely on AI's understanding of signal naming conventions
  - Consider context: signals that belong to the same functional block should be paired
```

### 修改2：保持连续性要求（必须连续）

**当前规则**（第109-113行）：
```
- **CRITICAL - Voltage Domain Continuity**: Voltage domains MUST be **contiguous and adjacent** in placement order
  - Signals belonging to the same voltage domain must form a continuous block
  - Cannot split voltage domain into disconnected segments (this would prevent proper power supply)
  - When grouping signals by name patterns, verify they form contiguous blocks in the signal placement order
  - If signals with similar names are separated by other signals, they belong to different voltage domains
```

**建议修改为**（强调和澄清）：
```
- **CRITICAL - Voltage Domain Continuity (MUST BE MAINTAINED)**: Voltage domains MUST be **contiguous and adjacent** in placement order
  - Signals belonging to the same voltage domain must form a continuous block
  - Cannot split voltage domain into disconnected segments (this would prevent proper power supply)
  - **Physical separation means different voltage domains**: If signals with similar names are separated by other signals, they belong to **different voltage domains**, even if they have the same name
  - Each contiguous block of signals with matching power/ground pair names forms an **independent voltage domain** with its own provider pair
  - Example: CVDD at left_2 (with CVSS at left_5) forms one voltage domain; CVDD at bottom_1 (with CVSS at bottom_0) forms a **different** voltage domain, even though they have the same signal names
```

### 修改3：使用语义理解选择提供者

**当前规则**（第114-120行）：
```
- **Determine voltage domain providers**:
  - **CRITICAL - One Provider Pair Per Domain**: Each voltage domain can have **ONLY ONE pair of providers** (one VDD provider and one VSS provider)
  - **CRITICAL - Even Same Name**: Even if multiple signals have the same name (e.g., multiple "AVDDH1" signals), **only ONE of them** can be selected as the provider
  - For each identified **contiguous** group, select **the first occurrence** of the main power/ground pair as providers
```

**建议修改为**：
```
- **Determine voltage domain providers using semantic understanding**:
  - **CRITICAL - One Provider Pair Per Domain**: Each voltage domain (contiguous block) can have **ONLY ONE pair of providers** (one VDD provider and one VSS provider)
  - **CRITICAL - Even Same Name**: Even if multiple signals have the same name (e.g., multiple "AVDDH1" signals), **only ONE of them** can be selected as the provider
  - **Use AI semantic understanding** to identify which signals are providers:
    - Understand the role of each signal in the circuit design
    - Typically, the first occurrence in a contiguous block is the provider, but should be confirmed by semantic understanding
    - Providers are signals that supply power to the domain; consumers receive power from providers
  - **Do NOT use simple "first occurrence" algorithm** - use semantic understanding to determine the appropriate provider
  - For each **contiguous block** of signals with matching power/ground pair:
    - Select ONE VDD signal as VDD provider (PVDD3AC) - typically the first, but confirm semantically
    - Select ONE VSS signal as VSS provider (PVSS3AC) - typically the first, but confirm semantically
    - All other signals in the same contiguous block are consumers (PVDD1AC/PVSS1AC)
```

### 修改4：数字/模拟信号区分
**说明**：此问题不需要修改知识库，数字/模拟信号的区分应该由AI语义理解自动完成。

### 修改5：强调使用语义理解进行配对

**当前规则**（第127-131行）：
```
- **Common patterns**:
  - VDDIB/VSSIB group → VDDIB and VSSIB as providers
  - VDDSAR/VSSSAR group → VDDSAR and VSSSAR as providers
  - VDD_CKB/VSS_CKB group → VDD_CKB and VSS_CKB as providers
  - AVDD/AVSS group → AVDD and AVSS as providers
```

**建议修改为**：
```
- **Use AI semantic understanding for pairing** (do NOT use character matching algorithms):
  - Understand the semantic meaning of signal names to identify power/ground pairs
  - Common semantic pairing examples:
    - VDDIB/VSSIB: Both contain "IB", semantically belong to IB module
    - AVDDH1/AVSS1: Both contain "1", semantically belong to module 1
    - AVDDVCO/AVSSVCO: Both contain "VCO", semantically belong to VCO module
    - CVDD/CVSS: Both contain "C", semantically belong to C module
    - VDDSAR/VSSSAR: Both contain "SAR", semantically belong to SAR module
  - **Do NOT use pattern extraction or character matching algorithms**
  - Rely on AI's understanding of circuit design naming conventions and semantic relationships
```

## 总结

主要问题：
1. **配对识别应该用语义理解** - 不应该用字符匹配算法，应该理解信号名称的语义含义
2. **连续性要求必须保持** - 物理上分开的信号属于不同的电压域，即使名称相同
3. **提供者选择应该用语义理解** - 不应该用"第一个"算法，应该理解信号在电路中的角色
4. **数字/模拟信号区分** - 不需要修改知识库，由AI语义理解自动完成

建议的修改方向：
- **强调使用AI语义理解**，而不是字符匹配算法
- **保持连续性要求**，明确分开的信号属于不同电压域
- **提供者选择基于语义理解**，理解信号在电路设计中的角色
- 所有识别和判断都应该基于AI的语义理解能力，而不是算法模式匹配

